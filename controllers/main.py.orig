<<<<<<< HEAD
from flask import *
import extensions
import hashlib
import uuid
import re

main = Blueprint('main', __name__, template_folder='templates', static_folder ='static/images')

@main.route('/')
def main_route():
    if 'username' in session:
        username=session['username']
        conn = extensions.connect_to_database()
        cursor = conn.cursor()
        sql3='select username from AlbumAccess' 
        cursor.execute(sql3)
        rows=cursor.fetchall()
        flag=0
        for row in rows:
            for ro in row:
                if ro==username:
                    flag=flag+1
        albumid=[]
        if flag>0:
            sql='select albumid from AlbumAccess where username="%s"' %username
            cursor.execute(sql)
            rows=cursor.fetchall()
            for ro in rows:
                for r in ro:
                    albumid.append(r)
        sql1='select albumid from Album where username="%s"' %username
        cursor.execute(sql1)
        rows=cursor.fetchall()
        for ro in rows:
            for r in ro:
                albumid.append(r)
        title=[]
        for i in albumid: 
            sql2='select title from Album where albumid="%s"' %i
            cursor.execute(sql2)
            x=cursor.fetchone()
            for j in x:
                title.append(j)
        sql2='select firstname, lastname, username from User'
        cursor.execute(sql2)
        rows=cursor.fetchall()
        firstname=[]
        lastname=[]
        user=[]
        for row in rows:
            firstname.append(row[0])
            lastname.append(row[1])
            user.append(row[2])
        cursor.close()
        conn.close()
        return render_template("index.html", zips=zip(firstname,lastname,user),link=zip(albumid,title))
    else:       
        conn = extensions.connect_to_database()
        cursor = conn.cursor()
        cursor.execute('select username, title, albumid from Album where access="public"')
        rows = cursor.fetchall()
        albumid=[]
        username=[]
        title=[]
        for row in rows:
                albumid.append(row[2])
                username.append(row[0])
                title.append(row[1])   
        cursor.close()
        conn.close()
        return render_template("index.html", links=zip(albumid,username,title))

@main.app_errorhandler(404)
def page_not_found(error):
    return render_template( "page_not_found.html" ), 404

@main.route('/login', methods=['GET', 'POST'])
def main_login():
    if request.method == 'GET':
        return render_template("login.html", error=[0,0,0,0])
    
    if request.method == 'POST':
        username=request.form['nm']
        password=request.form['pw']
        err = [0,0,0,0]
        correct = [0,0,0,0]
        if not username:
            err[0] = 1
        if not password:
            err[1] = 1
        if err != correct:
            return render_template("login.html", error=err)
        conn = extensions.connect_to_database()
        cursor=conn.cursor()
        sql1='select username from User'
        cursor.execute(sql1)
        row=cursor.fetchall()
        flag=0
        for ro in row:
            for r in ro:
                if r == username:
                    flag=1
        if flag == 0:
            err[2] = 1
        if err != correct:
            return render_template("login.html", error=err)
        sql='select password from User where username="%s"' %username
        cursor.execute(sql)
        row=cursor.fetchall()
        cursor.close()
        conn.close()
        passdb=''
        algorithm='sha512'
        for ro in row:
            for r in ro:
                passdb=r
        j=0
        loc=[]
        for i in passdb:
            if i=='$':
                loc.append(j)
            j=j+1
        salt=passdb[((loc[0])+1):((loc[1]))]
        m=hashlib.new(algorithm)
        m.update(salt+password)
        password_hash=m.hexdigest()
        new_hash="$".join([algorithm,salt,password_hash])
        if new_hash==passdb:
            session['username']=username
            return redirect(url_for('main.main_route'))
        else:
            err[3] = 1
            return render_template("login.html", error=err)


@main.route('/user',methods=['POST','GET'])
def main_user():
    if request.method=='POST':
        username=request.form['username']
        firstname=request.form['firstname']
        lastname=request.form['lastname']
        password=request.form['pw1']
        pw_verify=request.form['pw2']
        email=request.form['email']
        err=[]
        correct=[0,0,0,0,0,0,0,0]
        if username=="":
            err.append(1)
        else:
            err.append(0)
        if firstname=="":
            err.append(1)
        else:
            err.append(0)
        if lastname=="":
            err.append(1)
        else:
            err.append(0)
        if password=="":
            err.append(1)
        else:
            err.append(0)
        if email=="":
            err.append(1)
        else:
            err.append(0)
        conn = extensions.connect_to_database()
        cursor = conn.cursor()
        sql2='select username from User'
        cursor.execute(sql2)
        rows=cursor.fetchall()
        flag=0
        for row in rows:
            for ro in row:
                if username==ro:
                    flag=flag+1        
        if flag >=1:
            err.append(1)
        else:
            err.append(0)
        if len(username) <3:
            err.append(1)
        else:
            err.append(0)
        if re.match('^[a-zA-Z_0-9]+$',username):
            err.append(0)
        else:
            err.append(1)
        if err!=correct:
            return render_template("user.html",error=err)
        else:
            conn = extensions.connect_to_database()
            cursor = conn.cursor()
            algorithm='sha512'
            salt=uuid.uuid4().hex
            m=hashlib.new(algorithm)
            m.update(salt+password)
            password_hash=m.hexdigest()
            new_hash="$".join([algorithm,salt,password_hash])
            sql1='insert into User(username,firstname,lastname,password,email) values("%s","%s","%s","%s","%s")' %(username,firstname,lastname,new_hash,email)
            cursor.execute(sql1)
            cursor.close()
            conn.close()
            session['username']=username;
            return redirect(url_for('main.main_route'))
    else:
        return render_template("user.html",error=[0,0,0,0,0])

@main.route('/user/edit',methods=['POST','GET'])
def main_user_edit():
    if request.method == 'POST':
        username=session['username']
        conn = extensions.connect_to_database()
        cursor = conn.cursor()
        if 'firstname' in request.form.values():
            firstname=request.form['firstname']
            sql='update User set firstname="%s" where username="%s"' %(firstname,username)
            cursor.execute(sql)
            conn.close()
            cursor.close()
        elif 'lastname' in request.form.values():
            lastname=request.form['lastname']
            sql='update User set lastname="%s" where username="%s"' %(lastname,username)
            cursor.execute(sql)
            conn.close()
            cursor.close()
        elif 'email' in request.form.values():
            email=request.form['email']
            sql='update User set email="%s" where username="%s"' %(email,username)
            cursor.execute(sql)
            conn.close()
            cursor.close()
        elif 'pw1' in request.form.values() and 'pw2' in request.form.values():
            password=request.form['pw1']
            pw_verify=request.form['pw2']
            algorithm='sha512'
            salt=uuid.uuid4().hex
            m=hashlib.new(algorithm)
            m.update(salt+password)
            password_hash=m.hexdigest()
            new_hash="$".join([algorithm,salt,password_hash])
            sql='update User set password="%s" where username="%s"' %(newhash,username)
            cursor.execute(sql)
            conn.close()
            cursor.close()
            return render_template("user_edit.html")
        return render_template("user_edit.html")
    else:
        return render_template("user_edit.html")

@main.route('/user/logout')
def main_logout():
    session.clear()
    return redirect(url_for('main.main_route'))  



    
=======
from flask import *
import extensions
import hashlib
import uuid
import re

main = Blueprint('main', __name__, template_folder='templates', static_folder ='static/images')

@main.route('/')
def main_route():
    if 'username' in session:
        username=session['username']
        conn = extensions.connect_to_database()
        cursor = conn.cursor()
        sql3='select username from AlbumAccess' 
        cursor.execute(sql3)
        rows=cursor.fetchall()
        flag=0
        for row in rows:
            for ro in row:
                if ro==username:
                    flag=flag+1
        albumid=[]
        if flag>0:
            sql='select albumid from AlbumAccess where username="%s"' %username
            cursor.execute(sql)
            rows=cursor.fetchall()
            for ro in rows:
                for r in ro:
                    albumid.append(r)
        sql1='select albumid from Album where username="%s"' %username
        cursor.execute(sql1)
        rows=cursor.fetchall()
        for ro in rows:
            for r in ro:
                albumid.append(r)
        title=[]
        for i in albumid: 
            sql2='select title from Album where albumid="%s"' %i
            cursor.execute(sql2)
            x=cursor.fetchone()
            for j in x:
                title.append(j)
        sql2='select firstname, lastname, username from User'
        cursor.execute(sql2)
        rows=cursor.fetchall()
        firstname=[]
        lastname=[]
        user=[]
        for row in rows:
            firstname.append(row[0])
            lastname.append(row[1])
            user.append(row[2])
        cursor.close()
        conn.close()
        return render_template("index.html", zips=zip(firstname,lastname,user),link=zip(albumid,title))
    else:       
        conn = extensions.connect_to_database()
        cursor = conn.cursor()
        cursor.execute('select username, title, albumid from Album where access="public"')
        rows = cursor.fetchall()
        albumid=[]
        username=[]
        title=[]
        for row in rows:
                albumid.append(row[2])
                username.append(row[0])
                title.append(row[1])   
        cursor.close()
        conn.close()
        return render_template("index.html", links=zip(albumid,username,title))

@main.app_errorhandler(404)
def page_not_found(error):
    return render_template( "page_not_found.html" ), 404

@main.route('/login')
def main_login():
    return render_template("login.html")

@main.route('/user/validate', methods=['POST'])
def main_validate():
    username=request.form['nm']
    password=request.form['pw']
    conn = extensions.connect_to_database()
    cursor=conn.cursor()
    sql1='select username from User'
    cursor.execute(sql1)
    row=cursor.fetchall()
    flag=0
    for ro in row:
        for r in ro:
            if r == username:
                flag=1
    if flag == 0:
        abort(404)
    sql='select password from User where username="%s"' %username
    cursor.execute(sql)
    row=cursor.fetchall()
    cursor.close()
    conn.close()
    passdb=''
    algorithm='sha512'
    for ro in row:
        for r in ro:
            passdb=r
    j=0
    loc=[]
    for i in passdb:
	if i=='$':
		loc.append(j)
	j=j+1
    salt=passdb[((loc[0])+1):((loc[1]))]
    m=hashlib.new(algorithm)
    m.update(salt+password)
    password_hash=m.hexdigest()
    new_hash="$".join([algorithm,salt,password_hash])
    if new_hash==passdb:
        session['username']=username
        return redirect(url_for('main.main_route'))
    else:
        return "false"

@main.route('/user',methods=['POST','GET'])
def main_user():
    if request.method=='POST':
        username=request.form['username']
        firstname=request.form['firstname']
        lastname=request.form['lastname']
        password=request.form['pw1']
        pw_verify=request.form['pw2']
        email=request.form['email']
        err=[]
        correct=[0,0,0,0,0,0,0,0]
        if username=="":
            err.append(1)
        else:
            err.append(0)
        if firstname=="":
            err.append(1)
        else:
            err.append(0)
        if lastname=="":
            err.append(1)
        else:
            err.append(0)
        if password=="":
            err.append(1)
        else:
            err.append(0)
        if email=="":
            err.append(1)
        else:
            err.append(0)
        conn = extensions.connect_to_database()
        cursor = conn.cursor()
        sql2='select username from User'
        cursor.execute(sql2)
        rows=cursor.fetchall()
        flag=0
        for row in rows:
            for ro in row:
                if username==ro:
                    flag=flag+1        
        if flag >=1:
            err.append(1)
        else:
            err.append(0)
        if len(username) <3 and not err[0]:
            err.append(1)
        else:
            err.append(0)
        if re.match('^[a-zA-Z_0-9]+$',username):
            err.append(0)
        elif err[0]:
            err.append(0)
        else:
            err.append(1)
        if err!=correct:
            return render_template("user.html",error=err)
        else:
            conn = extensions.connect_to_database()
            cursor = conn.cursor()
            algorithm='sha512'
            salt=uuid.uuid4().hex
            m=hashlib.new(algorithm)
            m.update(salt+password)
            password_hash=m.hexdigest()
            new_hash="$".join([algorithm,salt,password_hash])
            sql1='insert into User(username,firstname,lastname,password,email) values("%s","%s","%s","%s","%s")' %(username,firstname,lastname,new_hash,email)
            cursor.execute(sql1)
            cursor.close()
            conn.close()
            session['username']=username;
            return redirect(url_for('main.main_route'))
    else:
        return render_template("user.html",error=[0,0,0,0,0])

@main.route('/user/edit',methods=['POST','GET'])
def main_user_edit():
    if request.method == 'POST':
        username=session['username']
        conn = extensions.connect_to_database()
        cursor = conn.cursor()
        if 'firstname' in request.form.values():
            firstname=request.form['firstname']
            sql='update User set firstname="%s" where username="%s"' %(firstname,username)
            cursor.execute(sql)
            conn.close()
            cursor.close()
        elif 'lastname' in request.form.values():
            lastname=request.form['lastname']
            sql='update User set lastname="%s" where username="%s"' %(lastname,username)
            cursor.execute(sql)
            conn.close()
            cursor.close()
        elif 'email' in request.form.values():
            email=request.form['email']
            sql='update User set email="%s" where username="%s"' %(email,username)
            cursor.execute(sql)
            conn.close()
            cursor.close()
        elif 'pw1' in request.form.values() and 'pw2' in request.form.values():
            password=request.form['pw1']
            pw_verify=request.form['pw2']
            algorithm='sha512'
            salt=uuid.uuid4().hex
            m=hashlib.new(algorithm)
            m.update(salt+password)
            password_hash=m.hexdigest()
            new_hash="$".join([algorithm,salt,password_hash])
            sql='update User set password="%s" where username="%s"' %(newhash,username)
            cursor.execute(sql)
            conn.close()
            cursor.close()
            return render_template("user_edit.html")
        return render_template("user_edit.html")
    else:
        return render_template("user_edit.html")

@main.route('/user/logout')
def main_logout():
    session.clear()
    return redirect(url_for('main.main_route'))  



    
>>>>>>> b193a001c1f62cfe92143cfcf6c49b0ebee617b3
